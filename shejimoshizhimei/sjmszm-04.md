# 设计原则与思想：规范和重构

## 27-理论一：什么情况下要重构？到底重构什么？又该如何重构？



### 重构的目的：为什么要重构（why）？



### 重构的对象：到底重构什么（what）？



### 重构的时机：什么时候重构（when）？



### 重构的方法：又该如何重构（how）？



## 28-理论二：为了保证重构不出错，有哪些非常能落地的技术手段？

当重构完成之后，如果新的代码仍然能通过单元测试，那就说明代码**原有逻辑的正确性未被破坏，原有的外部可见行为未变**。

### 什么是单元测试？

**集成测试**（Integration Testing）的测试对象是**整个系统或者某个功能模块**，比如测试**用户注册、登录功能**是否正常，是一种端到端（end to end）的测试。

**单元测试**（Unit Testing）的测试对象是**类或者函数**，用来测试一个类和函数是否都按照预期的逻辑执行。这是代码层级的测试。单元测试，测试的粒度更小一些。



### 为什么要写单元测试？

1. 单元测试能有效地帮你发现代码中的 bug

2. 写单元测试能帮你发现代码设计上的问题

3. 单元测试是对集成测试的有力补充

4. 写单元测试的过程本身就是代码重构的过程

5. 阅读单元测试能帮助你快速熟悉代码

6. 单元测试是 TDD 可落地执行的改进方案

    

### 如何编写单元测试？



1. 写单元测试真的是件很耗时的事情吗？
2. 对单元测试的代码质量有什么要求吗？
3. 单元测试只要覆盖率高就够了吗？
4. 写单元测试需要了解代码的实现逻辑吗？
5. 如何选择单元测试框架？



### 单元测试为何难落地执行？





## 29-理论三：什么是代码的可测试性？如何写出可测试性好的代码？



### 什么是代码的可测试性？

所谓代码的可测试性，就是针对代码**编写单元测试的难易程度**。对于一段代码，如果很难为其编写单元测试，或者单元测试写起来很费劲，需要依靠单元测试框架中很高级的特性，那往往就意味着代码设计得不够合理，代码的可测试性不好。

### 编写可测试性代码的最有效手段

依赖注入是编写可测试性代码的最有效手段。通过依赖注入，我们在编写单元测试的时候，可以通过 mock 的方法解依赖外部服务，这也是我们在编写单元测试的过程中最有技术挑战的地方。

### 常见的 Anti-Patterns

常见的测试不友好的代码有下面这 5 种：

- 代码中包含未决行为逻辑
- 滥用可变全局变量
- 滥用静态方法
- 使用复杂的继承关系
- 高度耦合的代码





## 30-理论四：如何通过封装、抽象、模块化、中间层等解耦代码？



### “解耦”为何如此重要？



### 代码是否需要“解耦”？



### 如何给代码“解耦”？

封装与抽象、中间层、模块化，以及一些其他的设计思想与原则，比如：单一职责原则、基于接口而非实现编程、依赖注入、多用组合少用继承、迪米特法则等。当然，还有一些设计模式，比如观察者模式。



## 31-理论五：让你最快速地改善代码质量的20条编程规范（上）

设计原则和设计模式非常依赖个人经验，用不好有时候会适得其反。

编码规范大部分都简单明了，在代码细节方面，能立竿见影地改善质量。

编码规范的三个部分：**命名与注释（Naming and Comments）、代码风格（Code Style）和编程技巧（Coding Tips）**。

### 命名

**大到项目名、模块名、包名、对外暴露的接口，小到类名、函数名、变量名、参数名**。

#### 1. 命名多长最合适？

在足够表达其含义的情况下，命名当然是越短越好。

对于作用域比较小的变量，我们可以使用相对短的命名。

#### 2. 利用上下文简化命名

#### 3. 命名要可读、可搜索

#### 4. 如何命名接口和抽象类？

### 注释

#### 1. 注释到底该写什么？

#### 2. 注释是不是越多越好？



## 32-理论五：让你最快速地改善代码质量的20条编程规范（中）



### 1. 函数、类多大才合适？

函数的代码行数不要超过一屏幕的大小，比如 50 行。类的大小限制比较难确定。

### 2. 一行代码多长最合适？

最好不要超过 IDE 显示的宽度。当然，限制也不能太小，太小会导致很多稍微长点的语句被折成两行，也会影响到代码的整洁，不利于阅读。

### 3. 善用空行分割单元块

对于比较长的函数，为了让逻辑更加清晰，可以使用空行来分割各个代码块。在类内部，成员变量与函数之间、静态成员变量与普通成员变量之间、函数之间，甚至成员变量之间，都可以通过添加空行的方式，让不同模块的代码之间的界限更加明确。

### 4. 四格缩进还是两格缩进？

我个人比较推荐使用两格缩进，这样可以节省空间，特别是在代码嵌套层次比较深的情况下。除此之外，值得强调的是，不管是用两格缩进还是四格缩进，一定不要用 tab 键缩进。

### 5. 大括号是否要另起一行？

我个人还是比较推荐将大括号放到跟上一条语句同一行的风格，这样可以节省代码行数。但是，将大括号另起一行，也有它的优势，那就是，左右括号可以垂直对齐，哪些代码属于哪一个代码块，更加一目了然。

### 6. 类中成员的排列顺序

在 Google Java 编程规范中，依赖类按照字母序从小到大排列。类中先写成员变量后写函数。成员变量之间或函数之间，先写静态成员变量或函数，后写普通变量或函数，并且按照作用域大小依次排列。



## 33-理论五：让你最快速地改善代码质量的20条编程规范（下）

编程技巧

### 1. 把代码分割成更小的单元块



### 2. 避免函数参数过多



### 3. 勿用函数参数来控制逻辑



### 4. 函数设计要职责单一



### 5. 移除过深的嵌套层次



### 6. 学会使用解释性变量





最后，还有一条非常重要的，那就是，项目、团队，甚至公司，一定要制定**统一的编码规范**，并且通过 Code Review 督促执行，这对提高代码质量有立竿见影的效果。



## 34-实战一（上）：通过一段ID生成器代码，学习如何发现代码质量问题



![](https://static001.geekbang.org/resource/image/04/c9/041e22cac6ce2ba3481e246c119adfc9.jpg)



![](https://static001.geekbang.org/resource/image/98/98/9894233257994a69102afa960692ce98.jpg)





## 35-实战一（下）：手把手带你将ID生成器代码从“能用”重构为“好用”



### 第一轮重构：提高代码的可读性

### 第二轮重构：提高代码的可测试性

### 第三轮重构：编写完善的单元测试

### 第四轮重构：所有重构完成之后添加注释



## 36-实战二（上）：程序出错该返回啥？NULL、异常、错误码、空对象？

## 37-实战二（下）：重构ID生成器项目中各函数的异常处理代码

